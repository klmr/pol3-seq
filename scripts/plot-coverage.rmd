```{r init}
modules::import('./knit')
```

We summarised the data in a previous analysis step, so we can just load it now.

```{r load-data}
(data = tbl_df(io$read_table('./results/coverage-summary-all.tsv',
                             header = TRUE)) %>%
    mutate(Stage = factor(Stage, c('E15.5', 'E18.5', 'P0.5', 'P4', 'P22', 'P29'))))
```

Library size normalise the data by dividing the coverage in each sample by the
sum of the coverage over all its features.

```{r normalize}
normalized = data %>%
    group_by(DO, Type) %>%
    mutate(LogLibrarySize = log(sum(Coverage))) %>%
    mutate(LogCoveragePerBase = log(Coverage) - log(BasesTotal)) %>%
    mutate(TPM = exp(LogCoveragePerBase - log(sum(exp(LogCoveragePerBase))) + log(1E6))) %>%
    select(-LogCoveragePerBase, -LogLibrarySize) %>%
    ungroup()
```

Average over replicates.

```{r average-replicates}
all_same = function (data) {
    stopifnot(length(unique(data)) == 1)
    first(data)
}

averaged = normalized %>%
    group_by(Type, Feature, IP, Tissue, Stage) %>%
    summarize(Coverage = mean(Coverage),
              TPM = mean(TPM),
              BasesTotal = all_same(BasesTotal)) %>%
    ungroup()
```

Plot fraction of binding to each feature, for each stage (we are just
interested in liver). Display only the top 10 highly covered features.

```{r plot, fig.width=12}
relative = averaged %>%
    filter(IP == 'PolIII' & Tissue == 'Liver') %>%
    group_by(Stage) %>%
    mutate(RelCoverage = Coverage / BasesTotal)

top = relative %>% top_n(10, Coverage) %>% ungroup()
top_rel = relative %>% top_n(10, RelCoverage) %>% ungroup()

ggplot(top_rel, aes(Stage, RelCoverage)) +
    geom_bar(aes(fill = Feature), stat = 'identity') +
    scale_y_continuous(name = 'Coverage [~FPKM]') +
    scale_fill_brewer(palette = 'Set3')
```

Letâ€™s double-check this with the inputs:

```{r plot-inputs, fig.width=12}
relative_input = averaged %>%
    filter(IP == 'Input' & Tissue == 'Liver') %>%
    group_by(Stage) %>%
    mutate(RelCoverage = Coverage / BasesTotal)

top_input = relative_input %>% top_n(10, Coverage) %>% ungroup()
top_rel_input = relative_input %>% top_n(10, RelCoverage) %>% ungroup()

ggplot(top_rel_input, aes(Stage, RelCoverage)) +
    geom_bar(aes(fill = Feature), stat = 'identity') +
    scale_y_continuous(name = 'Coverage [~FPKM]') +
    scale_fill_brewer(palette = 'Set3')
```

Plot TPM normalised mean coverge values.

```{r plot-tpm, fig.width=12}
top_10 = averaged %>%
    filter(IP == 'PolIII', Tissue == 'Liver', Feature %in% top_10) %>%
    group_by(Feature) %>%
    summarize(TPM = mean(TPM)) %>%
    arrange(TPM) %>%
    top_n(10, TPM) %>%
    .$Feature %>%
    factor(., levels = .)

tpm = averaged %>%
    filter(IP == 'PolIII', Tissue == 'Liver', Feature %in% top_10) %>%
    mutate(Feature = factor(Feature, levels = top_10))

ggplot(tpm, aes(Stage, TPM)) +
    geom_bar(aes(fill = Feature), stat = 'identity', position = 'fill') +
    scale_fill_brewer(palette = 'Set3')
```
